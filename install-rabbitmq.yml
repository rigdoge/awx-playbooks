---
- name: Deploy RabbitMQ 3.13.7 Container
  hosts: all
  become: yes
  tasks:
    - name: Create RabbitMQ directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      with_items:
        - /opt/rabbitmq/data
        - /opt/rabbitmq/config

    - name: Pull RabbitMQ image
      command: docker pull rabbitmq:3.13.7-management
      
    - name: Stop and remove existing container if exists
      command: docker rm -f rabbitmq
      ignore_errors: yes

    - name: Deploy RabbitMQ container
      command: >
        docker run -d 
        --name rabbitmq 
        --restart always 
        -p 5672:5672 
        -p 15672:15672 
        -e RABBITMQ_DEFAULT_USER=admin 
        -e RABBITMQ_DEFAULT_PASS=admin123 
        -v /opt/rabbitmq/data:/var/lib/rabbitmq 
        -v /opt/rabbitmq/config:/etc/rabbitmq 
        rabbitmq:3.13.7-management

    - name: Wait for RabbitMQ to be ready
      uri:
        url: http://localhost:15672
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 10
      ignore_errors: yes

    - name: Show RabbitMQ connection info
      debug:
        msg: 
          - "RabbitMQ is running"
          - "Management UI: http://localhost:15672"
          - "Username: admin"
          - "Password: admin123" 